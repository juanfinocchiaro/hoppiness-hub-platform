# HOPPINESS CLUB - Contexto del Proyecto para Cursor

## ğŸ¯ Â¿QUÃ‰ ES ESTE PROYECTO?

Sistema de gestiÃ³n interno para **Hoppiness**, una franquicia de hamburgueserÃ­as smash en Argentina (CÃ³rdoba). 

**IMPORTANTE:** Este sistema NO maneja ventas ni pedidos. Para eso usan **NÃºcleo Check** (sistema externo). Este sistema gestiona:
- RRHH (empleados, horarios, fichajes, coachings)
- Finanzas (gastos, compras, proveedores, P&L)
- ComunicaciÃ³n interna
- Supervisiones/inspecciones
- GestiÃ³n de la franquicia

---

## ğŸ›  STACK TECNOLÃ“GICO

| TecnologÃ­a | Uso |
|------------|-----|
| React 18 | Framework UI |
| Vite | Build tool |
| TypeScript | Tipado estricto |
| Supabase | Backend (PostgreSQL + Auth + Edge Functions + Storage) |
| TanStack Query | Data fetching y cache |
| Tailwind CSS | Estilos |
| shadcn/ui | Componentes UI |
| React Router v6 | Routing |
| date-fns | Manejo de fechas |
| Sonner | Toasts/notificaciones |
| Lucide React | Iconos |

---

## ğŸ“ ESTRUCTURA DE ARCHIVOS

```
src/
â”œâ”€â”€ App.tsx                 # Router principal - MIRA ESTO PRIMERO
â”œâ”€â”€ main.tsx               # Entry point
â”œâ”€â”€ index.css              # Estilos globales + Tailwind
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ admin/             # Componentes de Mi Marca
â”‚   â”œâ”€â”€ cuenta/            # Componentes de Mi Cuenta
â”‚   â”œâ”€â”€ local/             # Componentes de Mi Local
â”‚   â”œâ”€â”€ hr/                # RRHH (horarios, fichajes)
â”‚   â”œâ”€â”€ coaching/          # Sistema de coaching
â”‚   â”œâ”€â”€ meetings/          # Reuniones
â”‚   â”œâ”€â”€ finanzas/          # Compras, gastos, proveedores
â”‚   â”œâ”€â”€ inspections/       # Supervisiones
â”‚   â”œâ”€â”€ rdo/               # Resultado Diario Operativo (P&L)
â”‚   â”œâ”€â”€ menu/              # GestiÃ³n de carta
â”‚   â”œâ”€â”€ centro-costos/     # Centro de costos
â”‚   â”œâ”€â”€ guards/            # Route guards (RequireAuth, etc.)
â”‚   â”œâ”€â”€ layout/            # Sidebars y layouts
â”‚   â”œâ”€â”€ landing/           # Landing page pÃºblica
â”‚   â”œâ”€â”€ maps/              # IntegraciÃ³n Google Maps
â”‚   â””â”€â”€ ui/                # Componentes shadcn/ui
â”‚
â”œâ”€â”€ hooks/                 # 64 hooks custom
â”‚   â”œâ”€â”€ useAuth.tsx        # AutenticaciÃ³n
â”‚   â”œâ”€â”€ usePermissionsV2.ts # Sistema de permisos principal
â”‚   â”œâ”€â”€ useDynamicPermissions.ts # Permisos con overrides
â”‚   â”œâ”€â”€ usePermissionsWithImpersonation.ts # Para "ver como"
â”‚   â”œâ”€â”€ useSchedules.ts    # Horarios de empleados
â”‚   â”œâ”€â”€ useCoachings.ts    # Sistema de coaching
â”‚   â”œâ”€â”€ useMeetings.ts     # Reuniones
â”‚   â””â”€â”€ ... (61 mÃ¡s)
â”‚
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ admin/             # PÃ¡ginas de Mi Marca (/mimarca/*)
â”‚   â”œâ”€â”€ local/             # PÃ¡ginas de Mi Local (/milocal/:branchId/*)
â”‚   â”œâ”€â”€ cuenta/            # PÃ¡ginas de Mi Cuenta (/cuenta/*)
â”‚   â”œâ”€â”€ Index.tsx          # Landing
â”‚   â”œâ”€â”€ Ingresar.tsx       # Login/Registro
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ ImpersonationContext.tsx # Para "ver como otro usuario"
â”‚
â”œâ”€â”€ integrations/
â”‚   â””â”€â”€ supabase/
â”‚       â”œâ”€â”€ client.ts      # Cliente Supabase
â”‚       â””â”€â”€ types.ts       # Tipos generados (5987 lÃ­neas)
â”‚
â”œâ”€â”€ types/                 # Tipos TypeScript adicionales
â”‚   â”œâ”€â”€ coaching.ts
â”‚   â”œâ”€â”€ meeting.ts
â”‚   â”œâ”€â”€ shiftClosure.ts
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ lib/
    â”œâ”€â”€ utils.ts           # cn() para clases
    â”œâ”€â”€ errorHandler.ts    # Manejo de errores
    â””â”€â”€ ...
```

---

## ğŸ‘¥ SISTEMA DE ROLES

### Roles de Marca (brand_role) - Acceden a /mimarca
| Rol | DescripciÃ³n | Permisos clave |
|-----|-------------|----------------|
| `superadmin` | DueÃ±o de la marca | TODO |
| `coordinador` | Marketing/operaciones | CatÃ¡logo, comunicados, coaching |
| `informes` | Socio/inversor | Solo lectura de reportes |
| `contador_marca` | Contabilidad central | Finanzas, canon, ventas |

### Roles Locales (local_role) - Acceden a /milocal/:branchId
| Rol | DescripciÃ³n | Permisos clave |
|-----|-------------|----------------|
| `franquiciado` | DueÃ±o del local | Todo en su local |
| `encargado` | Manager dÃ­a a dÃ­a | Equipo, horarios, coaching |
| `contador_local` | Contabilidad local | Finanzas, compras |
| `cajero` | OperaciÃ³n bÃ¡sica | Fichaje, cierre de turno |
| `empleado` | Staff bÃ¡sico | Solo Mi Cuenta |

### Tabla de asignaciÃ³n: `user_branch_roles`
Un usuario puede tener:
- UN rol de marca (o ninguno)
- MÃšLTIPLES roles locales (uno por sucursal)

---

## ğŸ—º RUTAS PRINCIPALES

```
PÃšBLICAS:
/                    â†’ Landing
/ingresar           â†’ Login/Registro
/franquicias        â†’ Info franquicias
/contacto           â†’ Formulario contacto
/registro-staff     â†’ Registro empleados
/fichaje/:branchCode â†’ Fichaje por QR

MI CUENTA (autenticado):
/cuenta             â†’ Dashboard personal
/cuenta/perfil      â†’ Editar perfil
/cuenta/horario     â†’ Ver mi horario
/cuenta/fichajes    â†’ Mis fichajes
/cuenta/coachings   â†’ Mis evaluaciones
/cuenta/reuniones   â†’ Mis reuniones
/cuenta/solicitudes â†’ Mis solicitudes (dÃ­as libres)
/cuenta/adelantos   â†’ Mis adelantos de sueldo
/cuenta/comunicados â†’ Comunicados recibidos
/cuenta/reglamento  â†’ Firmar reglamentos

MI LOCAL (rol local requerido):
/milocal/:branchId/equipo              â†’ Lista de empleados
/milocal/:branchId/equipo/fichajes     â†’ Todos los fichajes
/milocal/:branchId/equipo/horarios     â†’ GestiÃ³n de horarios
/milocal/:branchId/equipo/coaching     â†’ Hacer coachings
/milocal/:branchId/equipo/reuniones    â†’ Reuniones del local
/milocal/:branchId/tiempo/liquidacion  â†’ Horas del mes
/milocal/:branchId/finanzas/proveedores â†’ Proveedores
/milocal/:branchId/finanzas/compras    â†’ Cargar compras
/milocal/:branchId/finanzas/gastos     â†’ Gastos operativos
/milocal/:branchId/finanzas/pl         â†’ P&L del local
/milocal/:branchId/ventas/historial    â†’ Cierres de turno

MI MARCA (rol marca requerido):
/mimarca                      â†’ Dashboard
/mimarca/locales/:slug        â†’ Detalle de local
/mimarca/usuarios             â†’ GestiÃ³n usuarios
/mimarca/comunicados          â†’ Enviar comunicados
/mimarca/coaching/encargados  â†’ Coaching a encargados
/mimarca/supervisiones        â†’ Inspecciones
/mimarca/finanzas/proveedores â†’ Proveedores de marca
/mimarca/finanzas/insumos     â†’ Insumos y costos
/mimarca/carta                â†’ GestiÃ³n de carta
/mimarca/recetas              â†’ Preparaciones
```

---

## ğŸ”§ CONVENCIONES DE CÃ“DIGO

### Naming
- **Hooks:** `use*` (useAuth, useSchedules, usePermissionsV2)
- **PÃ¡ginas:** `*Page.tsx` (TeamPage.tsx, CoachingPage.tsx)
- **Componentes:** PascalCase (EmployeeCard.tsx)
- **Utilidades:** camelCase (formatDate, calculateHours)

### React Query
```typescript
// Query key siempre descriptivo
queryKey: ['entity', id, filters]

// Ejemplo
queryKey: ['schedules', branchId, { month, year }]
```

### Supabase queries
```typescript
// Siempre manejar errores
const { data, error } = await supabase
  .from('tabla')
  .select('*')
  .eq('campo', valor);

if (error) throw error;
return data;
```

### Permisos
```typescript
// Usar el hook de permisos
const { local, brand, isSuperadmin } = usePermissionsWithImpersonation(branchId);

// Verificar permiso especÃ­fico
if (local.canEditSchedules) {
  // mostrar botÃ³n editar
}
```

---

## âš ï¸ PROBLEMAS CONOCIDOS - NO TOCAR SIN ENTENDER

### 1. Tabla eliminada: `item_extra_asignaciones`
Esta tabla fue eliminada. El cÃ³digo en estos archivos FALLARÃ:
- `hooks/useToggleExtra.ts`
- `hooks/useExtraAutoDiscovery.ts`
- `components/menu/ProductPreviewPanel.tsx`

**SoluciÃ³n correcta:** Usar `item_carta_composicion.es_extra`

### 2. Dos sistemas de catÃ¡logo
- **Sistema viejo:** `menu_productos`, `menu_categorias`, `menu_precios`
- **Sistema nuevo:** `items_carta`, `item_carta_composicion`

**El sistema nuevo (items_carta) es el que se debe usar.**

### 3. employee_id vs user_id
`employee_id` es legacy. Usar siempre `user_id`. Algunos lugares aÃºn usan employee_id por compatibilidad con constraints de BD.

### 4. Tres hooks de permisos
- `usePermissionsV2` â†’ Base
- `useDynamicPermissions` â†’ Agrega overrides de BD
- `usePermissionsWithImpersonation` â†’ Para "ver como otro usuario"

**Usar `usePermissionsWithImpersonation` en componentes de UI.**

---

## ğŸ—„ TABLAS PRINCIPALES DE SUPABASE

### Usuarios y Roles
- `profiles` - Datos del usuario
- `user_branch_roles` - Roles por sucursal

### Sucursales
- `branches` - Locales de la franquicia

### RRHH
- `clock_entries` - Fichajes
- `employee_schedules` - Horarios
- `schedule_requests` - Solicitudes dÃ­as libres
- `salary_advances` - Adelantos de sueldo
- `warnings` - Apercibimientos
- `coachings` - Evaluaciones
- `meetings` - Reuniones

### Finanzas
- `proveedores` - Proveedores
- `facturas_proveedores` - Facturas de compra
- `pagos_proveedores` - Pagos
- `gastos` - Gastos operativos
- `insumos` - Materias primas
- `periodos` - PerÃ­odos contables

### Carta
- `items_carta` - Productos de la carta
- `item_carta_composicion` - Ingredientes/preparaciones
- `preparaciones` - Recetas
- `menu_categorias` - CategorÃ­as

### ComunicaciÃ³n
- `communications` - Comunicados
- `regulations` - Reglamentos
- `regulation_signatures` - Firmas

### Operaciones
- `shift_closures` - Cierres de turno
- `branch_inspections` - Supervisiones

---

## ğŸ§ª CÃ“MO TESTEAR

### Localmente
```bash
npm run dev
# Abre http://localhost:5173
```

### Usuarios de prueba (si existen en tu BD)
Verificar en Supabase Dashboard â†’ Authentication â†’ Users

### Flujos a probar
1. **Login** â†’ RedirecciÃ³n segÃºn rol
2. **Mi Cuenta** â†’ Ver datos personales
3. **Fichaje** â†’ /fichaje/:branchCode
4. **Horarios** â†’ Crear/ver horarios
5. **Coaching** â†’ Crear evaluaciÃ³n

---

## ğŸ“ IDIOMA

- **CÃ³digo:** InglÃ©s (variables, funciones, componentes)
- **UI visible:** EspaÃ±ol argentino
- **Comentarios:** EspaÃ±ol estÃ¡ OK

---

## ğŸš« QUÃ‰ NO HACER

1. No crear nuevas tablas sin consultar la arquitectura existente
2. No duplicar hooks de permisos
3. No usar `employee_id` en cÃ³digo nuevo
4. No usar `menu_productos` - usar `items_carta`
5. No dejar console.log en commits
6. No hacer queries sin manejo de error

---

## âœ… CHECKLIST ANTES DE COMMITEAR

- [ ] No hay console.log
- [ ] Errores manejados con try/catch o .catch()
- [ ] Loading states implementados
- [ ] Permisos verificados donde corresponde
- [ ] Tipos TypeScript correctos (no `any` innecesarios)
- [ ] Textos en espaÃ±ol para UI
